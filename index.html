<script>
    // Fun√ß√£o para inicializar o mapa e os outros elementos ap√≥s carregar as credenciais
    function initializeApp(firebaseConfig) {
        // Inicializar Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('Firebase inicializado com sucesso');
        } catch (error) {
            console.error('Erro ao inicializar Firebase:', error);
            showStatus('Erro: Configure o Firebase primeiro', 'error');
            return;
        }

        // Inicializar o mapa
        const map = L.map('map').setView([-23.5505, -46.6333], 10); // S√£o Paulo como centro inicial

        // Adicionar camada do OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        let currentMarker = null;

        function addMarker(lat, lng) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            const customIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.3);"></div>',
                iconSize: [26, 26],
                iconAnchor: [13, 13]
            });
            currentMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
        }

        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            addMarker(lat, lng);
        });

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type} show`;
            setTimeout(() => {
                statusElement.classList.remove('show');
            }, 4000);
        }

        async function saveToFirebase(data) {
            try {
                if (!db) {
                    throw new Error('Firebase n√£o est√° configurado');
                }
                const docRef = await db.collection('comments').add({
                    ...data,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Documento salvo com ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Erro ao salvar no Firebase:', error);
                throw error;
            }
        }

        document.getElementById('commentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const comment = document.getElementById('comment').value.trim();
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            if (!comment) {
                showStatus('Por favor, escreva um coment√°rio', 'error');
                return;
            }
            if (!latitude || !longitude) {
                showStatus('Por favor, clique no mapa para selecionar uma localiza√ß√£o', 'error');
                return;
            }
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Enviando...';
            try {
                const data = {
                    comment: comment,
                    latitude: latitude,
                    longitude: longitude,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                };
                await saveToFirebase(data);
                showStatus('‚úÖ Coment√°rio salvo com sucesso!', 'success');
                document.getElementById('comment').value = '';
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                    currentMarker = null;
                }
            } catch (error) {
                console.error('Erro:', error);
                showStatus('‚ùå Erro ao salvar. Verifique a configura√ß√£o do Firebase.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Enviar Coment√°rio';
            }
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 13);
                },
                function(error) {
                    console.log('Erro ao obter localiza√ß√£o:', error);
                }
            );
        }

        map.whenReady(function() {
            console.log('Mapa carregado com sucesso');
        });
    }

    // Busca as credenciais da API do Vercel e s√≥ ent√£o inicializa a aplica√ß√£o
    fetch('/api/firebaseConfig')
        .then(response => response.json())
        .then(firebaseConfig => {
            console.log("Credenciais recebidas com sucesso!");
            initializeApp(firebaseConfig);
        })
        .catch(error => {
            console.error('Erro ao buscar as credenciais do Firebase:', error);
            document.getElementById('statusMessage').textContent = 'Erro ao carregar a aplica√ß√£o. Tente novamente.';
        });
</script>

